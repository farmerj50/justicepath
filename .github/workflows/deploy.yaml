name: Deploy monorepo to Cloud Run

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.GCP_REGION }}          # Cloud Run region (e.g., us-east4)
      AR_LOCATION: ${{ vars.AR_LOCATION }}    # AR location (us-east1)
      AR_REPO: ${{ vars.AR_REPO }}            # justicepath
      BACKEND_DIR: justicepath-backend
      FRONTEND_DIR: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.AR_LOCATION }}-docker.pkg.dev --quiet

      - name: Validate monorepo layout
        shell: bash
        run: |
          echo "BACKEND_DIR=${BACKEND_DIR}"
          echo "FRONTEND_DIR=${FRONTEND_DIR}"
          test -d "$BACKEND_DIR"  || { echo "Missing $BACKEND_DIR"; ls -la; exit 1; }
          test -d "$FRONTEND_DIR" || { echo "Missing $FRONTEND_DIR"; ls -la; exit 1; }
          test -f "$BACKEND_DIR/Dockerfile"  || { echo "No Dockerfile in $BACKEND_DIR"; exit 1; }
          test -f "$FRONTEND_DIR/Dockerfile" || { echo "No Dockerfile in $FRONTEND_DIR"; exit 1; }

      # -------------------------------
      # Build & deploy API
      # -------------------------------
      - name: Build & push API image
        env:
          IMAGE_API: ${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ vars.CR_SERVICE_API }}:${{ github.sha }}
        run: |
          set -e
          docker build -f "$BACKEND_DIR/Dockerfile" -t "$IMAGE_API" "$BACKEND_DIR"
          docker push "$IMAGE_API"

      - name: Deploy API
        id: deploy_api
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ vars.CR_SERVICE_API }}
          region: ${{ env.REGION }}
          image: ${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ vars.CR_SERVICE_API }}:${{ github.sha }}
          env_vars_update_strategy: merge
          env_vars: |
            NODE_ENV=production
            CORS_ALLOWLIST_JSON=${{ vars.CORS_ALLOWLIST_JSON }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
          flags: --allow-unauthenticated

          

      # -------------------------------
      # Build WEB with the correct API URL
      # -------------------------------
      - name: Decide API base for frontend
        id: decide_api
        shell: bash
        run: |
          API_BASE="${{ steps.deploy_api.outputs.url }}"
          echo "api_base=$API_BASE" >> "$GITHUB_OUTPUT"
          echo "::notice::Using API base: $API_BASE"

      - name: Build & push WEB image
        env:
          IMAGE_WEB: ${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ vars.CR_SERVICE_WEB }}:${{ github.sha }}
          API_BASE: ${{ steps.decide_api.outputs.url }}
          FRONTEND_DIR: ${{ env.FRONTEND_DIR }}
        run: |
          set -e
          docker build \
            --build-arg VITE_API_URL="$API_BASE" \
            -f "$FRONTEND_DIR/Dockerfile" \
            -t "$IMAGE_WEB" "$FRONTEND_DIR"
          docker push "$IMAGE_WEB"

      - name: Deploy WEB
        id: deploy_web
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ vars.CR_SERVICE_WEB }}
          region: ${{ env.REGION }}
          image: ${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ vars.CR_SERVICE_WEB }}:${{ github.sha }}
          flags: --allow-unauthenticated

      # -------------------------------
      # Patch API CORS with the live WEB URL
      # -------------------------------
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build allowlist (domains + live WEB url)
        id: cors
        shell: bash
        run: |
          set -e
          WEB_URL="${{ steps.deploy_web.outputs.url }}"
          ALLOW=$(jq -cn \
            --arg a https://justicepathlaw.com \
            --arg b https://www.justicepathlaw.com \
            --arg c "$WEB_URL" \
            '[$a,$b,$c]')
          echo "ALLOW=$ALLOW" >> "$GITHUB_OUTPUT"
          echo "::notice::CORS_ALLOWLIST_JSON=$ALLOW"

      - name: Patch API CORS_ALLOWLIST_JSON
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ vars.CR_SERVICE_API }}
          region:  ${{ env.REGION }}
          image:   ${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ vars.CR_SERVICE_API }}:${{ github.sha }}
          env_vars_update_strategy: merge
          env_vars: |
            CORS_ALLOWLIST_JSON=${{ steps.cors.outputs.ALLOW }}

      - name: Output URLs
        run: |
          echo "API URL: ${{ steps.deploy_api.outputs.url }}"
          echo "WEB URL: ${{ steps.deploy_web.outputs.url }}"
